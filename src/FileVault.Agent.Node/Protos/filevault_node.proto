syntax = "proto3";

package filevault.node.v1;

option csharp_namespace = "FileVault.Agent.Node.Protos";

service FileVaultNode {
  rpc Upload(stream FileChunk) returns (UploadResult);
  rpc Download(DownloadRequest) returns (stream ChunkData);
  rpc Delete(DeleteRequest) returns (DeleteResult);
  rpc GetHealth(HealthRequest) returns (NodeStatus);
}

// Chunk for upload streaming
message FileChunk {
  string objectId = 1;            // REQUIRED in first chunk, optional in subsequent chunks
  string createdAtUtc = 2;        // REQUIRED in first chunk, ISO-8601 format, optional in subsequent chunks
  bytes data = 3;                 // Chunk of file data, may be empty in first chunk
}

// Chunk for download streaming
message ChunkData {
  bytes data = 1;
}

message DownloadRequest {
  string objectId = 1;
  string finalPath = 2;  // optional, if not provided compute from objectId
}

message DeleteRequest {
  string objectId = 1;
  string finalPath = 2;  // optional, if not provided compute from objectId
}

message UploadResult {
  bool success = 1;
  string errorMessage = 2;
  string finalPath = 3;     // relative path from basePath
  int64 sizeBytes = 4;
  string checksum = 5;      // SHA-256 hex string
}

message DeleteResult {
  bool deleted = 1;
}

message HealthRequest {}

message NodeStatus {
  string nodeId = 1;
  bool isAlive = 2;
  int64 dataPathFreeBytes = 3;
  int64 dataPathTotalBytes = 4;
}
